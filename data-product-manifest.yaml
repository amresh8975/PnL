version: 0.0.25
jobId: "1168"
jobName: Non JPY Export Sales Price
jobType: Source Aligned Data Product
domain: finance
alias: load_non_jpy_export_price
discoveryPort:
  name: Non JPY Export Sales Price
inputPorts:
  - alias: Non_JPY_Price_1
    isDynamic: true
    path: /data/use-case/PnL/Output/Sales/Non_JPY_Price
    optional:
      persistDataFrame: false
      advanceOptions:
        delimiter: ","
      enableDataReconciliation: false
      enforceSchema: false
      connection: Finance On-Prem Connectivity
      dataSetUrn: urn:dv:dataset:22cf5026-9da3-43ba-a717-1ee99b95ce84
    type: inputDelimited
productState:
  isDynamic: true
  alias: load_non_jpy_export_price
  retentionVersions: ""
  logicalSchema:
    properties:
      model_code:
        type: STRING
        description: 16 digit Production Code
        sourceColumn: ""
        sourceTable: ""
      upload_description:
        type: STRING
        description: Description of 16 digit Production Code
        sourceColumn: ""
        sourceTable: ""
      continent:
        type: STRING
        description: Name of the continent in which the model is being exported
        sourceColumn: ""
        sourceTable: ""
      country:
        type: STRING
        description: Name of the country in which the model is being exported
        sourceColumn: ""
        sourceTable: ""
      region:
        type: STRING
        description: Name of the region in which the model is being sold
        sourceColumn: ""
        sourceTable: ""
      state:
        type: STRING
        description: Name of the state in which the model is being sold
        sourceColumn: ""
        sourceTable: ""
      city:
        type: STRING
        description: Name of the city in which the model is being sold
        sourceColumn: ""
        sourceTable: ""
      group_non_group:
        type: STRING
        description: Group or Non-group
        sourceColumn: ""
        sourceTable: ""
      trade_type:
        type: STRING
        description: Trade Type
        sourceColumn: ""
        sourceTable: ""
      port:
        type: STRING
        description: Port Name
        sourceColumn: ""
        sourceTable: ""
      currency:
        type: STRING
        description: Currency
        sourceColumn: ""
        sourceTable: ""
      year:
        type: STRING
        description: Financial Year
        sourceColumn: ""
        sourceTable: ""
      fob:
        type: STRING
        description: FOB Price
        sourceColumn: ""
        sourceTable: ""
      fob_exchange_rate:
        type: STRING
        description: Old Exchange Rate
        sourceColumn: ""
        sourceTable: ""
      budgeted_exchange_rate:
        type: STRING
        description: New Exchange Rate
        sourceColumn: ""
        sourceTable: ""
      price_change_sp_per:
        type: STRING
        description: Price Change due to strategic Pricing impact in %
        sourceColumn: ""
        sourceTable: ""
      price_change_sp_abs:
        type: STRING
        description: Price Change due to strategic Pricing impact in abs terms
        sourceColumn: ""
        sourceTable: ""
      price_change_er_per:
        type: STRING
        description: Price Change due to Exchange Rate impact in %
        sourceColumn: ""
        sourceTable: ""
      price_change_er_abs:
        type: STRING
        description: Price Change due to Exchange Rate impact in abs terms
        sourceColumn: ""
        sourceTable: ""
      month:
        type: STRING
        description: Month
        sourceColumn: ""
        sourceTable: ""
      etl_inserted_date:
        type: STRING
        description: Date when the record was inserted by ETL
      etl_modified_date:
        type: STRING
        description: Date when the record was last modified by ETL
      etl_created_by:
        type: STRING
        description: Creator of the ETL process
        sourceColumn: ""
        sourceTable: ""
      etl_updated_by:
        type: STRING
        description: Last updater of the ETL process
        sourceColumn: ""
        sourceTable: ""
  stateStoreType: loadDataIceberg
  isProfilingEnabled: false
  updateStrategy: Overwrite
  tableName: msil_dataverse_finance_catalog.export_non_jpy_sales_price
  warehousePath: /data/iceberg_warehouse
  catalogName: postgres
  optional:
    persistDataFrame: false
    enableDataReconciliation: false
    enforceSchema: false
    enforceSchemaMethod: Warning
    catalogType: postgres
  refreshInterval: None
transformation:
  - isDynamic: true
    alias: Spark_SQL_1
    description: transform non jpy export data
    sequence: 2
    inputDataFrameList:
      - inputDataFrame: Non_JPY_Price_1
        tempViewName: export_non_jpy_price
    query: with month_cte as(   select      all_months.col1 as
      month_name,      all_months.col2 as
      month_seq    from      (       select          explode(           array(             ("Apr",
      1),              ("May", 2),              ("Jun", 3),              ("Jul",
      4),              ("Aug", 5),              ("Sep", 6),              ("Oct",
      7),              ("Nov", 8),              ("Dec", 9),              ("Jan",
      10),              ("Feb", 11),              ("Mar",
      12)           )         ) as all_months     ) months_tab
      ),  export_non_jpy_price_cte
      as(   select      model_code,      upload_description,      continent,      country,      region,      state,      city,      Group_Non_Group,      trade_type,      port,      currency,      year,      fob,      fob_exchange_rate,      budgeted_exchange_rate,      price_change_sp_per,      price_change_sp_abs,      price_change_er_per,      price_change_erabs
      as price_change_er_abs,      case when initcap(       trim(month)     ) in
      ('Apr', 'April') then 'Apr' when initcap(       trim(month)     ) in
      ('May') then 'May' when initcap(       trim(month)     ) in ('Jun',
      'June') then 'Jun' when initcap(       trim(month)     ) in ('Jul',
      'July') then 'Jul' when initcap(       trim(month)     ) in ('Aug',
      'August') then 'Aug' when initcap(       trim(month)     ) in ('Sep',
      'September') then 'Sep' when initcap(       trim(month)     ) in ('Oct',
      'October') then 'Oct' when initcap(       trim(month)     ) in ('Nov',
      'November') then 'Nov' when initcap(       trim(month)     ) in ('Dec',
      'December') then 'Dec' when initcap(       trim(month)     ) in ('Jan',
      'January') then 'Jan' when initcap(       trim(month)     ) in ('Feb',
      'February') then 'Feb' when initcap(       trim(month)     ) in ('Mar',
      'March') then 'Mar' end as month    from      export_non_jpy_price
      ),  propagation_tab as
      (   select      row_gen_months.model_code,      row_gen_months.upload_description,      row_gen_months.currency,      row_gen_months.month_name
      as month,      last_value(       export_non_jpy_price.month, true     )
      over (       partition by
      row_gen_months.model_code,        row_gen_months.upload_description,        row_gen_months.currency        order
      by          row_gen_months.month_seq     )
      proagation_month    from      (       (         select            distinct
      model_code,            upload_description,            currency          from            export_non_jpy_price_cte       )
      as export_non_jpy_price cross        join month_cte     )
      row_gen_months      left join export_non_jpy_price_cte
      export_non_jpy_price on export_non_jpy_price.model_code =
      row_gen_months.model_code      and export_non_jpy_price.upload_description
      = row_gen_months.upload_description      and export_non_jpy_price.currency
      = row_gen_months.currency      and export_non_jpy_price.month =
      row_gen_months.month_name
      )  select    export_non_jpy_price.model_code,    export_non_jpy_price.upload_description,    export_non_jpy_price.continent,    export_non_jpy_price.country,    export_non_jpy_price.region,    export_non_jpy_price.state,    export_non_jpy_price.city,    export_non_jpy_price.Group_Non_Group,    export_non_jpy_price.trade_type,    export_non_jpy_price.port,    export_non_jpy_price.currency,    case
      when propagation_tab.proagation_month in (     'Apr', 'May', 'Jun', 'Jul',
      'Aug', 'Sep',      'Oct', 'Nov', 'Dec'   )    and propagation_tab.month in
      ('Jan', 'Feb', 'Mar') then export_non_jpy_price.year + 1 else
      export_non_jpy_price.year end as year,    Cast( export_non_jpy_price.fob
      as decimal(38, 5)) fob,    Cast( export_non_jpy_price.fob_exchange_rate as
      decimal(38, 5)) fob_exchange_rate,    Cast(
      export_non_jpy_price.budgeted_exchange_rate as decimal(38, 5))
      budgeted_exchange_rate,    Cast( export_non_jpy_price.price_change_sp_per
      as decimal(38, 5)) price_change_sp_per,    Cast(
      export_non_jpy_price.price_change_sp_abs as decimal(38, 5))
      price_change_sp_abs,    Cast( export_non_jpy_price.price_change_er_per as
      decimal(38, 5)) price_change_er_per,    Cast(
      export_non_jpy_price.price_change_er_abs as decimal(38, 5))
      price_change_er_abs,    propagation_tab.MONTH,    current_timestamp() as
      etl_inserted_date,    current_timestamp() as
      etl_modified_date,    'platform_admin' as
      etl_created_by,    'platform_admin' as
      etl_updated_by  from    export_non_jpy_price_cte as
      export_non_jpy_price    inner join propagation_tab on
      export_non_jpy_price.model_code = propagation_tab.model_code    and
      export_non_jpy_price.upload_description =
      propagation_tab.upload_description    and export_non_jpy_price.currency =
      propagation_tab.currency    and export_non_jpy_price.month =
      propagation_tab.proagation_month
    optional:
      persistDataFrame: false
    type: operationThroughSqlQuery
controlPort:
  dataQualityRules:
    NullValueCheck:
      productState:
        checks:
          - column: model_code
        referenceAlias: load_non_jpy_export_price
outputPort:
  subscriptionChannels:
    - channelType: Postgres
      queryType: SQL
    - channelType: Dataproduct
      queryType: SQL
