version: 0.0.17
jobId: "1157"
jobName: JPY Export Sales Price
jobType: Source Aligned Data Product
domain: finance
alias: load_to__JPY_Export_table_
discoveryPort:
  name: JPY Export Sales Price
inputPorts:
  - alias: JPY_Price_1
    isDynamic: true
    path: /data/use-case/PnL/Output/Sales/JPY_Price
    optional:
      persistDataFrame: false
      advanceOptions:
        delimiter: ","
      enableDataReconciliation: false
      enforceSchema: false
      connection: Finance On-Prem Connectivity
      dataSetUrn: urn:dv:dataset:a5500e8a-bea3-47a5-872f-cf9bbf00f21b
    type: inputDelimited
productState:
  isDynamic: true
  alias: load_to__JPY_Export_table_
  retentionVersions: ""
  logicalSchema:
    properties:
      model_code:
        type: STRING
        description: 16 digit Production Code
        sourceColumn: ""
        sourceTable: ""
      upload_description:
        type: STRING
        description: Description of 16 digit Production Code
        sourceColumn: ""
        sourceTable: ""
      continent:
        type: STRING
        description: Name of the continent in which the model is being exported
        sourceColumn: ""
        sourceTable: ""
      country:
        type: STRING
        description: Name of the country in which the model is being exported
        sourceColumn: ""
        sourceTable: ""
      region:
        type: STRING
        description: Name of the region in which the model is being sold
        sourceColumn: ""
        sourceTable: ""
      state:
        type: STRING
        description: Name of the state in which the model is being sold
        sourceColumn: ""
        sourceTable: ""
      city:
        type: STRING
        description: Name of the city in which the model is being sold
        sourceColumn: ""
        sourceTable: ""
      group_non_group:
        type: STRING
        description: Group or Non-group
        sourceColumn: ""
        sourceTable: ""
      trade_type:
        type: STRING
        description: Trade Type
        sourceColumn: ""
        sourceTable: ""
      port:
        type: STRING
        description: Port Name
        sourceColumn: ""
        sourceTable: ""
      currency:
        type: STRING
        description: Currency
        sourceColumn: ""
        sourceTable: ""
      year:
        type: STRING
        description: Financial Year
        sourceColumn: ""
        sourceTable: ""
      cost:
        type: STRING
        description: Cost
        sourceColumn: ""
        sourceTable: ""
      capacity_cost_adj:
        type: STRING
        description: Cost Adjustments for Capacity Utilization
        sourceColumn: ""
        sourceTable: ""
      material_cost_adj:
        type: STRING
        description: Material Cost Adjustments
        sourceColumn: ""
        sourceTable: ""
      proposed_margin_rate:
        type: STRING
        description: Proposed Margin Rate
        sourceColumn: ""
        sourceTable: ""
      month:
        type: STRING
        description: Month
        sourceColumn: ""
        sourceTable: ""
      etl_inserted_date:
        type: STRING
        description: Date when the record was inserted by ETL
      etl_modified_date:
        type: STRING
        description: Date when the record was last modified by ETL
      etl_created_by:
        type: STRING
        description: Creator of the ETL process
        sourceColumn: ""
        sourceTable: ""
      etl_updated_by:
        type: STRING
        description: Last updater of the ETL process
        sourceColumn: ""
        sourceTable: ""
  stateStoreType: loadDataIceberg
  isProfilingEnabled: false
  updateStrategy: Overwrite
  tableName: msil_dataverse_finance_catalog.export_jpy_sales_price
  warehousePath: /data/iceberg_warehouse
  catalogName: postgres
  optional:
    persistDataFrame: false
    enableDataReconciliation: false
    enforceSchema: false
    enforceSchemaMethod: Warning
    catalogType: postgres
  refreshInterval: None
transformation:
  - isDynamic: true
    alias: Spark_SQL_1
    description: transform the JPY Sales Data
    sequence: 2
    inputDataFrameList:
      - inputDataFrame: JPY_Price_1
        tempViewName: export_jpy_price
    query: with month_cte as(   select      all_months.col1 as
      month_name,      all_months.col2 as
      month_seq    from      (       select          explode(           array(             ("Apr",
      1),              ("May", 2),              ("Jun", 3),              ("Jul",
      4),              ("Aug", 5),              ("Sep", 6),              ("Oct",
      7),              ("Nov", 8),              ("Dec", 9),              ("Jan",
      10),              ("Feb", 11),              ("Mar",
      12)           )         ) as all_months     ) months_tab
      ),  export_jpy_price_cte
      as(   select      model_code,      upload_description,      continent,      country,      region,      state,      city,      Group_Non_Group,      trade_type,      port,      currency,      year,      cost,      capacity_cost_adj,      material_cost_adj,      proposed_margin_rate,      case
      when initcap(       trim(month)     ) in ('Apr', 'April') then 'Apr' when
      initcap(       trim(month)     ) in ('May') then 'May' when
      initcap(       trim(month)     ) in ('Jun', 'June') then 'Jun' when
      initcap(       trim(month)     ) in ('Jul', 'July') then 'Jul' when
      initcap(       trim(month)     ) in ('Aug', 'August') then 'Aug' when
      initcap(       trim(month)     ) in ('Sep', 'September') then 'Sep' when
      initcap(       trim(month)     ) in ('Oct', 'October') then 'Oct' when
      initcap(       trim(month)     ) in ('Nov', 'November') then 'Nov' when
      initcap(       trim(month)     ) in ('Dec', 'December') then 'Dec' when
      initcap(       trim(month)     ) in ('Jan', 'January') then 'Jan' when
      initcap(       trim(month)     ) in ('Feb', 'February') then 'Feb' when
      initcap(       trim(month)     ) in ('Mar', 'March') then 'Mar' end as
      month    from      export_jpy_price ),  propagation_tab as
      (   select      row_gen_months.model_code,      row_gen_months.upload_description,      row_gen_months.month_name
      as month,      last_value(export_jpy_price.month, true) over
      (       partition by
      row_gen_months.model_code,        row_gen_months.upload_description        order
      by          row_gen_months.month_seq     )
      proagation_month    from      (       (         select            distinct
      model_code,            upload_description          from            export_jpy_price_cte       )
      as export_jpy_price cross        join month_cte     )
      row_gen_months      left join export_jpy_price_cte export_jpy_price on
      export_jpy_price.model_code = row_gen_months.model_code      and
      export_jpy_price.upload_description =
      row_gen_months.upload_description      and export_jpy_price.month =
      row_gen_months.month_name
      )  select    export_jpy_price.model_code,    export_jpy_price.upload_description,    export_jpy_price.continent,    export_jpy_price.country,    export_jpy_price.region,    export_jpy_price.state,    export_jpy_price.city,    export_jpy_price.Group_Non_Group,    export_jpy_price.trade_type,    export_jpy_price.port,    export_jpy_price.currency,    case
      when propagation_tab.proagation_month in (     'Apr', 'May', 'Jun', 'Jul',
      'Aug', 'Sep',      'Oct', 'Nov', 'Dec'   )    and propagation_tab.month in
      ('Jan', 'Feb', 'Mar') then export_jpy_price.year + 1 else
      export_jpy_price.year end as year,    Cast(     export_jpy_price.cost as
      decimal(38, 5)   ) cost,    Cast(     export_jpy_price.capacity_cost_adj
      as decimal(38, 5)   )
      capacity_cost_adj,    Cast(     export_jpy_price.material_cost_adj as
      decimal(38, 5)   )
      material_cost_adj,    Cast(     export_jpy_price.proposed_margin_rate as
      decimal(38, 5)   ) proposed_margin_rate,    propagation_tab.MONTH
      ,    current_timestamp() as etl_inserted_date,    current_timestamp() as
      etl_modified_date,    'platform_admin' as
      etl_created_by,    'platform_admin' as
      etl_updated_by  from    export_jpy_price_cte as export_jpy_price    inner
      join propagation_tab on export_jpy_price.model_code =
      propagation_tab.model_code    and export_jpy_price.upload_description =
      propagation_tab.upload_description    and export_jpy_price.month =
      propagation_tab.proagation_month
    optional:
      persistDataFrame: false
    type: operationThroughSqlQuery
controlPort:
  dataQualityRules:
    NullValueCheck:
      productState:
        checks:
          - column: model_code
        referenceAlias: load_to__JPY_Export_table_
outputPort:
  subscriptionChannels:
    - channelType: Postgres
      queryType: SQL
    - channelType: Dataproduct
      queryType: SQL
