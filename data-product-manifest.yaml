version: 0.0.12
jobId: "1168"
jobName: PnL Non JPY Export Sales Price
jobType: Source Aligned Data Product
domain: finance
alias: load_to_tgt
discoveryPort:
  name: PnL Non JPY Export Sales Price
inputPorts:
  - alias: Non_JPY_Price_1
    isDynamic: true
    path: /data/PnL/Output/Sales/Non_JPY_Price/
    optional:
      persistDataFrame: false
      advanceOptions:
        delimiter: ","
      enableDataReconciliation: false
      enforceSchema: false
      connection: Finance On-Prem Connectivity
      dataSetUrn: urn:dv:dataset:22cf5026-9da3-43ba-a717-1ee99b95ce84
    type: inputDelimited
productState:
  isDynamic: true
  alias: load_to_tgt
  retentionVersions: ""
  logicalSchema:
    properties:
      model_code:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      upload_description:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      continent:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      country:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      region:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      state:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      city:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      group_non_group:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      trade_type:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      port:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      currency:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      year:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      fob:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      fob_exchange_rate:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      budgeted_exchange_rate:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      price_change_sp_per:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      price_change_sp_abs:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      price_change_er_per:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      price_change_er_abs:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
      month:
        type: STRING
        description: ""
        sourceColumn: ""
        sourceTable: ""
  stateStoreType: loadDataIceberg
  isProfilingEnabled: false
  updateStrategy: Overwrite
  tableName: msil_dataverse_finance_catalog.export_non_jpy_price_monthly
  warehousePath: /data/iceberg_warehouse
  catalogName: postgres
  optional:
    persistDataFrame: false
    enableDataReconciliation: false
    enforceSchema: false
    enforceSchemaMethod: Warning
    catalogType: postgres
  refreshInterval: None
transformation:
  - isDynamic: true
    alias: Spark_SQL_1
    description: transform
    sequence: 2
    inputDataFrameList:
      - inputDataFrame: Non_JPY_Price_1
        tempViewName: export_non_jpy_price
    query: with month_cte as(  select all_months.col1 as month_name, all_months.col2
      as month_seq  from (   select explode(array(("Apr", 1), ("May", 2),
      ("Jun", 3), ("Jul", 4), ("Aug", 5), ("Sep", 6), ("Oct", 7), ("Nov", 8),
      ("Dec", 9), ("Jan", 10), ("Feb", 11), ("Mar", 12))) as all_months   )
      months_tab  ), export_non_jpy_price_cte as(  select    model_code   ,
      upload_description   , continent   , country   , region   , state   ,
      city   , Group_Non_Group   , trade_type   , port   , currency   , year   ,
      fob   , fob_exchange_rate   , budgeted_exchange_rate   ,
      price_change_sp_per   , price_change_sp_abs   , price_change_er_per   ,
      price_change_erabs as price_change_er_abs   , case when
      initcap(trim(month)) in ('Apr', 'April') then 'Apr'     when
      initcap(trim(month)) in ('May') then 'May'    when initcap(trim(month)) in
      ('Jun', 'June') then 'Jun'     when initcap(trim(month)) in ('Jul',
      'July') then 'Jul'     when initcap(trim(month)) in ('Aug', 'August') then
      'Aug'     when initcap(trim(month)) in ('Sep', 'September') then
      'Sep'     when initcap(trim(month)) in ('Oct', 'October') then
      'Oct'     when initcap(trim(month)) in ('Nov', 'November') then
      'Nov'     when initcap(trim(month)) in ('Dec', 'December') then
      'Dec'     when initcap(trim(month)) in ('Jan', 'January') then
      'Jan'     when initcap(trim(month)) in ('Feb', 'February') then
      'Feb'     when initcap(trim(month)) in ('Mar', 'March') then 'Mar'     end
      as month  FROM   export_non_jpy_price  ), propagation_tab as (  select
      row_gen_months.model_code   , row_gen_months.upload_description   ,
      row_gen_months.currency   , row_gen_months.month_name as month   ,
      last_value(export_non_jpy_price.month, True) over (partition by
      row_gen_months.model_code, row_gen_months.upload_description,
      row_gen_months.currency order by row_gen_months.month_seq)
      proagation_month  from    ((select distinct model_code,
      upload_description, currency from export_non_jpy_price_cte) as
      export_non_jpy_price   cross join    month_cte   ) row_gen_months   left
      join   export_non_jpy_price_cte
      export_non_jpy_price   on  export_non_jpy_price.model_code =
      row_gen_months.model_code    AND export_non_jpy_price.upload_description =
      row_gen_months.upload_description    AND export_non_jpy_price.currency =
      row_gen_months.currency    AND export_non_jpy_price.month =
      row_gen_months.month_name  ) select   export_non_jpy_price.model_code  ,
      export_non_jpy_price.upload_description  ,
      export_non_jpy_price.continent  , export_non_jpy_price.country  ,
      export_non_jpy_price.region  , export_non_jpy_price.state  ,
      export_non_jpy_price.city  , export_non_jpy_price.Group_Non_Group  ,
      export_non_jpy_price.trade_type  , export_non_jpy_price.port  ,
      export_non_jpy_price.currency  , export_non_jpy_price.year  ,
      export_non_jpy_price.fob  , export_non_jpy_price.fob_exchange_rate  ,
      export_non_jpy_price.budgeted_exchange_rate  ,
      export_non_jpy_price.price_change_sp_per  ,
      export_non_jpy_price.price_change_sp_abs  ,
      export_non_jpy_price.price_change_er_per  ,
      export_non_jpy_price.price_change_er_abs  , propagation_tab.month
      from  export_non_jpy_price_cte as export_non_jpy_price inner
      join  propagation_tab ON export_non_jpy_price.model_code =
      propagation_tab.model_code  AND export_non_jpy_price.upload_description =
      propagation_tab.upload_description  AND export_non_jpy_price.currency =
      propagation_tab.currency  AND export_non_jpy_price.month =
      propagation_tab.proagation_month
    optional:
      persistDataFrame: false
    type: operationThroughSqlQuery
controlPort:
  dataQualityRules: {}
outputPort:
  subscriptionChannels:
    - channelType: Postgres
      queryType: SQL
    - channelType: Dataproduct
      queryType: SQL
